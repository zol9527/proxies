name: Proxy Deploy
description: ğŸ¤– è‡ªåŠ¨çˆ¬å–å¹¶æ›´æ–°ä»£ç†IPåˆ—è¡¨

on:
  schedule:
    - cron: '*/30 * * * *'  # æ¯20åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    concurrency:
      group: ${{ github.workflow }}-proxy-deploy
      cancel-in-progress: true
    steps:
      - name: ğŸ“¥ æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          ref: dev
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ï¼Œé¿å…æ¨é€å†²çª
      
      - name: ğŸ”§ è®¾ç½®Goç¯å¢ƒ
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.5'
      
      - name: ğŸ“¦ ç¼“å­˜Goä¾èµ–
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-
      
      - name: âš™ï¸ å®‰è£…ä¾èµ–
        run: go mod download

      - name: ğŸ” é…ç½®ä»“åº“æƒé™
        run: |
          echo "ğŸ”‘ é…ç½® GitHub Token æƒé™..."
          git config --global url."https://${{ github.token }}@github.com/".insteadOf "https://github.com/"
          # éªŒè¯æƒé™
          echo "âœ… GitHub æƒé™é…ç½®å®Œæˆ"
          
      - name: ğŸƒ è¿è¡Œä»£ç 
        run: |
          echo "ğŸ”„ å¼€å§‹æ‰§è¡Œä»£ç†IPçˆ¬å–ä»»åŠ¡..."
          # å°è¯•å¤šä¸ªå¯èƒ½çš„å…¥å£ç‚¹
          go run ./cmd/main.go || go run ./main.go || echo "âŒ æ‰¾ä¸åˆ°ä¸»ç¨‹åºå…¥å£"
          echo "âœ… çˆ¬å–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•"
      
      - name: ğŸ’¾ æäº¤æ›´æ”¹
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'
          
          # æ£€æŸ¥æ˜¯å¦æœ‰æ–°çš„ä»£ç†IPæ–‡ä»¶ç”Ÿæˆ
          if [[ -f ip.txt ]]; then
            echo "ğŸ“‹ å‘ç°æ–°çš„ä»£ç†IPåˆ—è¡¨"
            # è®¡ç®—æ–°å‘ç°çš„ä»£ç†IPæ•°é‡
            IP_COUNT=$(wc -l < ip.txt)
            git add ip.txt
            git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ï¼šå‘ç° ${IP_COUNT} ä¸ªå¯ç”¨ä»£ç†IP"
          else
            echo "ğŸ“‹ æ²¡æœ‰å‘ç°æ–°çš„ä»£ç†IPåˆ—è¡¨"
            # æ·»åŠ æ‰€æœ‰å¯èƒ½çš„æ›´æ”¹
            git add .
            git diff --quiet && git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨æ›´æ–°ï¼šè¿è¡Œä»£ç ç”Ÿæˆçš„æ›´æ”¹"
          fi
      
      - name: ğŸš€ æ¨é€æ›´æ”¹
        run: |
          echo "ğŸ“¤ æ­£åœ¨æ¨é€æ›´æ”¹åˆ°ä»“åº“..."
          git push || (git pull --rebase && git push)
          echo "âœ… æ›´æ”¹å·²æˆåŠŸæ¨é€"
